<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Minecraft Server Status</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen transition-colors duration-300" id="bodyEl">
  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">Minecraft Server Status</h1>

    <div class="mb-6 flex gap-2">
      <input id="hostInput" class="flex-1 border p-2 rounded" placeholder="e.g. mc.hypixel.net" value="mc.universocraft.com">
      <button id="applyBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Check</button>
    </div>

    <div class="flex justify-between items-center mb-4">
      <label for="refreshRate">Refresh every:</label>
      <select id="refreshRate" class="border rounded p-1">
        <option value="30000">30s</option>
        <option value="60000">1m</option>
        <option value="300000">5m</option>
      </select>
      <button id="themeToggle" class="ml-auto bg-gray-300 dark:bg-gray-700 px-3 py-1 rounded">Toggle Theme</button>
    </div>

    <div id="statusSection" class="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-3">
      <div class="flex items-center gap-2">
        <img id="favicon" src="" alt="Server Icon" class="w-8 h-8 rounded">
        <div><strong>Status:</strong> <span id="statusText">–</span></div>
      </div>
      <div><strong>Players:</strong> <span id="playersNow">–</span> / <span id="playersMax">–</span></div>
      <div><strong>Ping:</strong> <span id="ping">–</span> ms</div>
      <div><strong>Version:</strong> <span id="version">–</span></div>
      <div><strong>Protocol:</strong> <span id="protocol">–</span></div>
      <div><strong>Software:</strong> <span id="software">–</span></div>
      <div><strong>Plugins:</strong> <span id="plugins">–</span></div>
      <div><strong>MOTD:</strong> <pre id="motd" class="whitespace-pre-wrap"></pre></div>
      <div class="flex items-center gap-2">
        <strong>IP / Port:</strong> <span id="ipPort">–</span>
        <button id="copyIpBtn" class="bg-blue-600 text-white text-sm px-2 py-1 rounded">Copy</button>
      </div>
      <div><strong>NameMC:</strong> <a id="namemcLink" href="#" target="_blank" class="text-blue-600 underline">–</a></div>
      <div><strong>Minecraft-MP:</strong> <a id="mcMpLink" href="#" target="_blank" class="text-blue-600 underline">–</a></div>
      <div><strong>Last update:</strong> <span id="lastUpdate">–</span></div>
      <div><strong>Checked:</strong> <span id="timeAgo">–</span> ago</div>
    </div>
  </div>

  <script>
    const API = "https://api.mcsrvstat.us/3/";

    const hostInput = document.getElementById('hostInput');
    const applyBtn = document.getElementById('applyBtn');
    const statusText = document.getElementById('statusText');
    const playersNow = document.getElementById('playersNow');
    const playersMax = document.getElementById('playersMax');
    const pingEl = document.getElementById('ping');
    const versionEl = document.getElementById('version');
    const protocolEl = document.getElementById('protocol');
    const softwareEl = document.getElementById('software');
    const pluginsEl = document.getElementById('plugins');
    const motdEl = document.getElementById('motd');
    const ipPortEl = document.getElementById('ipPort');
    const lastUpdate = document.getElementById('lastUpdate');
    const timeAgoEl = document.getElementById('timeAgo');
    const namemcLink = document.getElementById('namemcLink');
    const mcMpLink = document.getElementById('mcMpLink');
    const faviconEl = document.getElementById('favicon');
    const copyIpBtn = document.getElementById('copyIpBtn');
    const refreshRateSelect = document.getElementById('refreshRate');
    const themeToggle = document.getElementById('themeToggle');
    const bodyEl = document.getElementById('bodyEl');

    let refreshInterval;
    let lastCheckTime;

    function updateTimeAgo() {
      if (!lastCheckTime) return;
      const seconds = Math.floor((Date.now() - lastCheckTime) / 1000);
      timeAgoEl.textContent = seconds + "s";
    }

    async function fetchStatus(host) {
      try {
        const res = await fetch(API + encodeURIComponent(host));
        const data = await res.json();

        statusText.textContent = data.online ? "Online" : "Offline";
        playersNow.textContent = data.players?.online ?? 0;
        playersMax.textContent = data.players?.max ?? "–";
        pingEl.textContent = data.debug?.ping ?? "–";
        versionEl.textContent = data.version || "–";
        protocolEl.textContent = data.protocol || "–";
        softwareEl.textContent = data.software || "–";
        pluginsEl.textContent = data.plugins ? data.plugins.join(", ") : "–";
        motdEl.textContent = (Array.isArray(data.motd?.clean) ? data.motd.clean.join("\n") : data.motd?.clean) || "";
        ipPortEl.textContent = (data.ip || host) + (data.port ? ":" + data.port : "");
        namemcLink.href = `https://namemc.com/server/${host}`;
        namemcLink.textContent = host;
        mcMpLink.href = `https://minecraft-mp.com/server-s/${host}`;
        mcMpLink.textContent = host;
        faviconEl.src = data.icon ? `data:image/png;base64,${data.icon}` : "";

        lastUpdate.textContent = new Date().toLocaleString();
        lastCheckTime = Date.now();
        updateTimeAgo();
      } catch {
        statusText.textContent = "Error fetching information";
      }
    }

    applyBtn.onclick = () => {
      const host = hostInput.value.trim();
      if (!host) return;
      fetchStatus(host);
    };

    copyIpBtn.onclick = () => {
      navigator.clipboard.writeText(ipPortEl.textContent);
      copyIpBtn.textContent = "Copied!";
      setTimeout(() => copyIpBtn.textContent = "Copy", 2000);
    };

    refreshRateSelect.onchange = () => {
      clearInterval(refreshInterval);
      refreshInterval = setInterval(() => fetchStatus(hostInput.value.trim()), parseInt(refreshRateSelect.value));
    };

    themeToggle.onclick = () => {
      bodyEl.classList.toggle("dark");
      bodyEl.classList.toggle("bg-gray-900");
      bodyEl.classList.toggle("text-white");
    };

    // Auto-refresh
    refreshInterval = setInterval(() => fetchStatus(hostInput.value.trim()), parseInt(refreshRateSelect.value));
    setInterval(updateTimeAgo, 1000);

    fetchStatus(hostInput.value.trim());
  </script>

  <section class="max-w-5xl mx-auto p-6">
    <h2 class="text-2xl font-bold mt-10 mb-4 text-center">Top hosts by country (animated)</h2>

    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3 text-center">Paste a list of servers (one per line), then scan. We will resolve each server, geolocate its IP via public APIs, and compute who appears most often per country. No scraping required.</p>

    <div class="grid gap-3 md:grid-cols-2">
      <textarea id="bulkHosts" class="border rounded p-3 min-h-[160px]" placeholder="e.g.
mc.hypixel.net
mc.universocraft.com
play.cubecraft.net
play.mineplex.net
..."></textarea>
      <div class="flex flex-col gap-2">
        <button id="scanBtn" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded">Scan servers</button>
        <div class="text-xs text-gray-500">Tips:
          <ul class="list-disc list-inside">
            <li>Large lists are ok; we throttle requests automatically.</li>
            <li>Results depend on servers being online and geolocation accuracy.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="scanProgress" class="mt-3 text-sm text-gray-600 dark:text-gray-300">Idle.</div>

    <div id="leaderboardWrap" class="mt-6 grid gap-4 md:grid-cols-2">
      <!-- Dynamic country leaderboards appear here -->
    </div>
  </section>

  <style>
    /* Simple, lightweight animations */
    .fade-in { opacity: 0; transform: translateY(6px); animation: fadeInUp .5s ease forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .count-burst { animation: pop .3s ease; }
    @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }
    .shimmer { position: relative; overflow: hidden; }
    .shimmer::after{ content:""; position:absolute; top:0; left:-150%; width:50%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); animation: shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{left:-150%} 100%{left:150%} }
  </style>

  <script>
    // ====== NEW: Animated Top Hosts by Country ======
    const bulkHosts = document.getElementById('bulkHosts');
    const scanBtn = document.getElementById('scanBtn');
    const scanProgress = document.getElementById('scanProgress');
    const leaderboardWrap = document.getElementById('leaderboardWrap');

    // Helper: throttle concurrency
    async function mapLimit(items, limit, iterator) {
      const ret = []; let i = 0; const executing = [];
      while (i < items.length) {
        const p = Promise.resolve().then(() => iterator(items[i], i++));
        ret.push(p);
        if (limit <= items.length) {
          const e = p.then(() => executing.splice(executing.indexOf(e), 1));
          executing.push(e);
          if (executing.length >= limit) await Promise.race(executing);
        }
      }
      return Promise.allSettled(ret);
    }

    function normalizeList(text){
      return Array.from(new Set(text.split(/
+/).map(s=>s.trim()).filter(Boolean)));
    }

    function updateProgress(done, total){
      scanProgress.textContent = `Processing ${done}/${total}…`;
    }

    function renderCountryBoards(countryMap){
      leaderboardWrap.innerHTML = '';
      const countries = Object.keys(countryMap).sort((a,b)=> countryMap[b].total - countryMap[a].total);
      countries.forEach((cc, idx)=>{
        const info = countryMap[cc];
        const top = Object.entries(info.isps).sort((a,b)=> b[1]-a[1]);
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 rounded-2xl shadow p-4 fade-in';
        card.style.animationDelay = `${Math.min(idx*80,600)}ms`;
        const rows = top.slice(0,5).map(([isp,count],i)=>{
          const barPct = Math.round((count/info.total)*100);
          return `<div class="mt-2">
            <div class="flex justify-between text-sm"><span>${i+1}. ${isp}</span><span class="font-semibold">${count}</span></div>
            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded">
              <div class="h-2 bg-blue-600 rounded count-burst" style="width:${barPct}%;"></div>
            </div>
          </div>`;
        }).join('');
        card.innerHTML = `
          <div class="text-xs text-gray-500">Country</div>
          <div class="text-xl font-bold">${info.countryName} <span class="text-sm text-gray-500">(${cc})</span></div>
          <div class="text-xs text-gray-500 mt-1">Servers seen: <span class="font-semibold">${info.total}</span></div>
          <div class="mt-2">${rows || '<div class="text-sm text-gray-500">No ISP data</div>'}</div>
        `;
        leaderboardWrap.appendChild(card);
      });
    }

    async function resolveServer(host){
      // 1) resolve + status (for IP)
      try {
        const r = await fetch(`${API}${encodeURIComponent(host)}`);
        if (!r.ok) return null;
        const j = await r.json();
        const ip = j && (j.ip || j.hostname || null);
        const port = j && j.port;
        return { ip, port, ok: !!j.online, raw:j };
      } catch { return null; }
    }

    async function geoLookup(ip){
      // Use ip-api.com (fast, CORS ok)
      try {
        const r = await fetch(`https://ip-api.com/json/${ip}?fields=status,country,countryCode,org,isp,as,query`);
        if (!r.ok) return null;
        const j = await r.json();
        if (j.status !== 'success') return null;
        return { cc: j.countryCode, country: j.country, isp: j.isp || j.org || (j.as||'').split(' ').slice(1).join(' ') || 'Unknown' };
      } catch { return null; }
    }

    async function scanAll(){
      const hosts = normalizeList(bulkHosts.value);
      if (!hosts.length){ scanProgress.textContent = 'Please paste at least one host.'; return; }
      leaderboardWrap.innerHTML = '';
      scanProgress.textContent = 'Starting…';

      const countryMap = {}; let done = 0;
      await mapLimit(hosts, 6, async (host)=>{
        const res = await resolveServer(host);
        if (res && res.ip){
          const g = await geoLookup(res.ip);
          if (g){
            const cc = g.cc || '??';
            if (!countryMap[cc]) countryMap[cc] = { countryName: g.country || cc, total: 0, isps: {} };
            countryMap[cc].total += 1;
            countryMap[cc].isps[g.isp] = (countryMap[cc].isps[g.isp]||0)+1;
          }
        }
        done++; updateProgress(done, hosts.length);
      });

      renderCountryBoards(countryMap);
      scanProgress.textContent = 'Done.';
    }

    scanBtn.addEventListener('click', scanAll);
  </script>
</body>
</html>
